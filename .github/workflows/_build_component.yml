name: Build component

on:
  workflow_call:
    inputs:
      environment:
        description: "Environment name."
        type: string
      layer:
        description: "Layer name."
        type: string
      component:
        description: "Ð¡omponent name."
        type: string

jobs:
  build_component:
    name: build_component (${{ inputs.component }})
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}-no-approve
    env:
      layer: ${{ inputs.layer }}
      component: ${{ inputs.component }}
      ENVIRONMENT: ${{ inputs.environment }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
    defaults:
      run:
        working-directory: src/terragrunt/${{ inputs.layer }}/${{ inputs.component }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: ./.github/actions/setup_terraform

      - name: Setup Terragrunt
        uses: ./.github/actions/setup_terragrunt

      - name: 'Azure login'
        uses: azure/login@v1
        with:
            client-id: ${{ secrets.AZURE_CLIENT_ID }}
            tenant-id: ${{ secrets.AZURE_TENANT_ID }}
            subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terragrunt init
        shell: bash
        run: |
          terragrunt init -reconfigure
      
      - name: Terragrunt validate
        shell: bash
        run: |
          terragrunt validate
      
      - name: Terragrunt plan
        shell: bash
        run: |
          terragrunt plan -out ${layer}-${component}.tfplan
      
      # TODO: I do not think I need here publishing artifact. Not sure. Where will be another build that will require artifact to be published.
      - name: Publish terraform plan
        shell: bash
        run: |
          echo "Publishing terraform plan"
          ls -lh 